{% if ram.base is undefined or ram.size is undefined %}
  {{ missingvalue("Unable to find RAM to provide OpenOCD a work area") }}
{% endif %}
# JTAG adapter setup
adapter_khz     10000

set chain_length 5

{% block ftdi_interface %}{% endblock %}

set _CHIPNAME riscv
jtag newtap $_CHIPNAME cpu -irlen $chain_length

set _TARGETNAME $_CHIPNAME.cpu
target create $_TARGETNAME.0 riscv -chain-position $_TARGETNAME
  
$_TARGETNAME.0 configure -work-area-phys {{ ram.base|format_hex }} -work-area-size {{ ram.size|format_hex }} -work-area-backup 1

if { $chain_length == 6 } {
  riscv use_bscan_tunnel 5
}

{% if flash.mem_base is defined and flash.control_base is defined %}
flash bank spi0 fespi {{ flash.mem_base|format_hex }} 0 0 0 $_TARGETNAME.0 {{ flash.control_base|format_hex }}
{% endif %}

init
# If required, the authdata_write command must be added immediately after the 'init' command
# Use:
# riscv authdata_write ????????

if { [info exists authkey] } {
  riscv authdata_write $authkey
}

if {[ info exists pulse_srst]} {
  ftdi_set_signal nSRST 0
  ftdi_set_signal nSRST z
  sleep 1500
}
halt

{% if flash is defined %}
flash protect 0 64 last off
{% endif %}

echo "Ready for Remote Connections"
